---
layout: post
title:  "Optimization"
date:   2017-08-24 08:00:00
author: minguss
categories: devlog compiler
tags: performance
---


Reference: https://opentutorials.org/module/2004/11698  
https://wiki.kldp.org/wiki.php/GccOptimizationOptions  
http://idkwim.tistory.com/80  
https://wiki.gentoo.org/wiki/GCC_optimization/en  
http://jinynet9.tistory.com/113

GCov를 사용할 때, 아무옵션도 지정하지 말 것을 권장한다.  
왜 최적화를 권장하지 않는지에 대해서 궁금했고, Options에는 어떤 것들이 있는지 정리할 필요가 있어 Posting하게 되었다.  

기본적으로 GCC는 아무런 옵션을 지정하지 않으면 코드를 최적화 시키지 않는다고 한다. 

### 최적화 옵션  
최적화는 실행파일의 크기를 줄여 메모리와 하드디스크의 공간을 절약하는 것과 실행 속도를 향상시키는 것을 의마한다. 물론 프로그램의 원래 기능은 유지되어야 한다.

><최적화 기법>
>1. 과도한 함수 호출 제거
>2. 상수의 전달과 변수 복제 전달의 최적화
>3. 불필요한 loop제거
>1. 상수의 곱셈 최적화
>1. 함수 호출 인수의 지연된 pop 동작 방지(스택 최소화)
>1. 재귀 호출이 함수의 최종부에서 일어나지 않도록 최적화
>1. 효율적인 레지스터 할당
>1. 유추에 의한 변수 최적화
>1. inline 함수의 최적화와 스택 프레임 포인터의 제거
>1. 각 명령의 실행 사이클을 고려한 스케줄링
>1. 반복되는 코드의 제거
>1. 루프에서의 동작 불편 코드 옮김
>1. 각 하드웨어에서 지원하는 단축 명령 기능에 의한 지역 최적화

GCC는 -O[최적화 레벨]옵션으로 여러 최적화 기법을 묶어 놓은 최적화 방법을 사용할 수 있다.  
이전 포스팅에서 Qmake로 생성된 -O2 옵션에서 -O0 옵션으로 변경한 내용을 포스팅 했는데, -O 옵션에는 다음과 같은 기법을 묶어놓았다.



| 최적화 레벨 |                                                                                                                                              의미                                                                                                                                              |
|-------------|:----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------:|
|     -O0     | 최적화를 완전히 끄고, CFLAGS 또는 CXXFLAGS에 -O 레벨을 기본으로 지정하지 않았을 경우에 기본값이 된다. 컴파일 시간을 줄이고 디버그 정보를 개선할 수 있지만, 어떤 프로그램은 최적화를 활성화 하지 않으면 제대로 동작하지 않을 수 있다. 이 옵션은 디버깅 목적이 아니라면 사용하지 않는 것이 좋다. |
|     -O1     | 기본적인 최적화를 수행한다. 컴파일러는 더 많은 컴파일 시간을 소비하지 않고도 빠르고 작은 코드를 만들어낸다.                                                                                                                                                                                    |
|     -O2     | 가장 많이 사용하는 최적화 옵션이며, 대부분의 최적화를 수행한다. 메모리 공간과 속도를 희생하지 않는 범위내의 모든 최적화를 수행한다. loop unrolling과 function inlining에 대한 최적화를 수행하지 않는다.                                                                                        |
|     -O3     | -O2 최적화에 inline 함수와 register에 대한 최적화를 추가로 수행한다.                                                                                                                                                                                                                           |
|     -Os     | 코드 크기를 최적화 한다. 만든 코드의 크기가 늘어나지 않게 하는 모든 -O2 옵션을 활성화 한다. 매우 제한된 디스크 저장소 공간을 가지고 있거나 CPU의 캐시 크기가 작을 경우 유용하다.                                                                                                               |
|     -Og     | GCC4.8에 새로운 최적화 옵션으로, 빠른 컴파일이 장점이다.                                                                                                                                                                                                                                       |
|    -Ofast   | GCC 4.7에서 새로 도입했으며, -O3, -ffast-math, -fno-protect-parens, and -fstack-arrays로 이루어져 있다. 이 옵션은 엄격한 표준 준수를 깨며, 사용을 권장하지 않는다.                                                                                                                             |

>`**커널 컴파일 시 최적화 옵션 -O2만 사용하는 이유**`  
커널은 인라인 함수를 많이 사용하고 있다. -O3 최적화는 컴파일러가 판단해서 인라인을 인라인이 빠른 것은 인라인으로, 함수가 빠른 것은 함수로 바꿔버린다. 커널은 최적화된 수행 속도를 위해 의도적으로 인라인 함수를 사용하고 있어서 컴파일러에 의해서 자의적으로 함수로 바뀌는 것을 막기 위해 -O2 옵션을 사용한다.

[GCC Optimization Options](https://gcc.gnu.org/onlinedocs/gcc/Optimize-Options.html)
